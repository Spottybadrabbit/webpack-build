webpack-build
=============

[![Build Status](https://travis-ci.org/markfinger/webpack-build.svg?branch=master)](https://travis-ci.org/markfinger/webpack-build)
[![Dependency Status](https://david-dm.org/markfinger/webpack-build.svg)](https://david-dm.org/markfinger/webpack-build)
[![devDependency Status](https://david-dm.org/markfinger/webpack-build/dev-status.svg)](https://david-dm.org/markfinger/webpack-build#info=devDependencies)

Wraps webpack and exposes an API suitable for tool chains and request cycles.

Does a bunch of things, including:

- Multiple concurrent compilers
- Persistent caching to reduce build times
- HMR support
- Easy environment configuration


Documentation
-------------

- [Installation](#installation)
- [Basic usage](#basic-usage)
- [Configuration](#configuration)
- [Caching](#caching)
- [Environment configuration](#environment-configuration)
- [HMR](#hmr)
- [Debugging](#debugging)
- [Building the project](#building-the-project)
- [Running the tests](#running-the-tests)
- [Colophon](#colophon)


Installation
------------

```bash
npm install webpack-build
```


Basic usage
-----------

```javascript
var build = require('webpack-build');

build({
  config: '/path/to/webpack.config.js'
}), function(err, stats) {
  // ...
});
```


Configuration
-------------

```javascript
{

  // An absolute path to a config file
  config: '/path/to/webpack.config.js',
  
  // Watching
  // --------

  watch: true,
  aggregateTimeout: 200,
  poll: undefined,

  // Config manipulation
  // -------------------

  env: '', // the env to apply
  outputPath: '', // override for output.path
  publicPath: '', // override for output.publicPath

  // External system integration
  // ---------------------------

  staticRoot: '', // Absolute path to your root static dir
  staticUrl: '', // Url to your root static dir

  // Caching
  // -------

  cache: true,
  cacheDir: path.join(process.cwd(), '.webpack_cache'),

  // Hot module replacement
  // ----------------------

  hmr: false, // if true, hmr code is injected
  hmrRoot: '', // The address of the build server
  hmrPath: '/__webpack_hmr__', // the mount point of the socket handler

}
```


Compilation output
------------------

The wrapper provides the output of webpack's `stats.toJson` method, with
some non-standard props:

- `webpackConfig`: the config object generated and passed to webpack
- `assets`: an object mapping asset names to the full path of the generated asset
- `urls`: an object mapping asset names to the full url of the generated asset.
  The values are generated by subtracting `staticRoot` from the values in `assets` and
  prepending `staticUrl`
- `rendered`: an object providing arrays of `<script>` and `<link>` elements pointing to
  the values from `urls`

Caching
-------

A combination of persistent files and in-memory data are used to improve build times.

Once your first compilation request has completed successfully, the output is cached and
subsequent requests will be served from memory. Cached output is written to disk, so cold
boots will experience comparable performance.

When serving cached data, a compiler will be spun up in the background and the cache will
continue to serve data only until the compiler has completed. Spawning a compiler enables
webpack's incremental compilation to provide almost instantaneous builds.

To avoid serving stale data, the wrapper tracks file and package dependencies. File timestamps
and package versions are checked before serving up any cached data. If the cached data is ever
deemed to be stale, requests will be blocked until the compiler completes.


Environment configuration
-------------------------

You can specify functions in your config file which can be run to generate
environment-specific configuration.

```javascript
module.exports = {
  // ...
  env: {
    dev: function(config, opts) {
      config.devtool = 'eval';

      config.loaders.push({
        // ...
      });

      if (opts.hmr) {
        // ...
      }
    },
    prod: function(config, opts) {
      config.devtool = 'source-map';
    }
  }
};
```

To apply an environment configuration, pass in the `env` option to the wrapper

```javascript
var build = require('webpack-build');

build({
  // ...
  env: 'dev'
}, function(err, stats) {
  // ...
});
```

`env` functions are provided with both your config file's object and your options object you
passed in to build.

The wrapper also comes with some convenience functions that help you to avoid boilerplate.

```javascript
var build = require('webpack-build');

module.exports = {
  // ...
  env: {
    dev: build.env.dev,
    prod: build.env.prod
  }
};
```

`build.env.dev(config, opts)` makes the following changes and additions

```javascript
{
  output: {
    // ...
    pathinfo: true
  },
  devtool: 'eval-source-maps',
  plugins: [
    // ...
    new webpack.optimize.OccurrenceOrderPlugin(),
    new webpack.NoErrorsPlugin(),
    new webpack.DefinePlugin({
      'process.env': {NODE_ENV: JSON.stringify('development')}
    })
  ]
}
```

`build.env.prod(config, opts)` makes the following changes and additions

```javascript
{
  devtool: 'source-maps',
  plugins: [
    // ...
    new webpack.optimize.OccurrenceOrderPlugin(),
    new webpack.NoErrorsPlugin(),
    new webpack.optimize.DedupePlugin(),
    new webpack.optimize.UglifyJsPlugin(),
    new webpack.DefinePlugin({
      'process.env': {NODE_ENV: JSON.stringify('production')}
    })
  ]
}
```


HMR
---

webpack-build includes hooks to add HMR functionality

```javascript
var build = require('webpack-build');

build({
  config: '/path/to/webpack.config.js',
  hmr: true,
  hmrRoot: 'http://127.0.0.1:8000',
  outputPath: '/path/to/output/dir',
  publicPath: '/static/output/dir',
}, function(err, stats) {
  // ...
});
```

When assets are rendered on the front-end, they open sockets to the build server and
attempt to hot update whenever possible. If hot updates are not possible, console logs
will indicate the need to refresh for updates to be applied.


Debugging
---------

The environment variable DEBUG is respected by the library's logger.

To expose verbose logs to your shell, run your process with `DEBUG=webpack-build:* ...`

If you want better stack traces, turn on source maps

```javascript
import sourceMapSupport from 'source-map-support';

sourceMapSupport.install({
  handleUncaughtExceptions: false
});
```


Building the project
--------------------

```bash
npm run build

# or

npm run build -- --watch
```


Running the tests
-----------------

```bash
npm run build
npm test
```


Colophon
--------

Large portions of this codebase are heavily indebted to
[webpack-dev-middleware](https://github.com/webpack/webpack-dev-middleware) and
[webpack-dev-server](https://github.com/webpack/webpack-dev-server).

This project stands on the shoulders of giants - specifically, Tobias Koppers and the
webpack ecosystem's vast number of contributors.
