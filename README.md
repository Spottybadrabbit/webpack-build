webpack-build
=============

[![Build Status](https://travis-ci.org/markfinger/webpack-build.svg?branch=master)](https://travis-ci.org/markfinger/webpack-build)
[![Dependency Status](https://david-dm.org/markfinger/webpack-build.svg)](https://david-dm.org/markfinger/webpack-build)
[![devDependency Status](https://david-dm.org/markfinger/webpack-build/dev-status.svg)](https://david-dm.org/markfinger/webpack-build#info=devDependencies)

A build library which wraps webpack and provides a variety of optimizations and utilities.


Features
--------

- Supports multiple concurrent compilers
- Uses a persistent caching layer to reduce build times
- Provides a simple hook to extend a server for HMR support
- Provides config hooks to ensure that your config files reflect the current environment
- Provides convenience functions to keep typical dev/prod boilerplate out of your config files
- Pre-processes compilation output so that it can be serialized and efficiently passed
  between processes
- Provides a helper to redirect the compiler's output to a particular directory
- Provides watchers to detect changes to your config files


Documentation
-------------

- [Installation](#installation)
- [Basic usage](#basic-usage)
- [Configuration](#configuration)
- [Caching](#caching)
- [Environment configuration](#environment-configuration)
- [HMR](#hmr)
- [Colophon](#colophon)


Installation
------------

```bash
npm install webpack-build
```


Basic usage
-----------

```javascript
var build = require('webpack-build');

build({config: '/path/to/webpack.config.js'}), function(err, stats) {
  // Besides the usual stats data produced by webpack, the wrapper adds 
  // some extra props...
  
  // The config object generated by webpack
  stats.webpackConfig
  
  // An object mapping asset names to the full path of the generated asset
  stats.pathsToAssets
  
  // An object mapping asset names to the full url of the generated asset.
  // Requires the `staticRoot` and `staticUrl` settings to be defined
  stats.urlsToAssets

  // An array of rendered <script> elements pointing to the JS assets
  stats.rendered.scripts

  // An array of rendered <link> elements pointing to the CSS assets
  stats.rendered.styleSheets
});
```


Configuration
-------------

```javascript
{

  // An absolute path to a config file
  config: '/path/to/webpack.config.js',
  
  // The following options are the default values...
  
  // Indicates that webpack should watch the source files for changes 
  // and rebuild in the background
  watch: false,
  
  // An absolute path to a file that will be used to store cached data
  cacheFile: null,

  // The cache key used to distinguish the current request's compilation.
  // If not defined, it is set to `opts.config + '__' + opts.hash`
  cacheKey: null,

  // A hash value used to distinguish requests, cached values, and hmr connections. 
  // If not defined, the wrapper serializes the options provided and generates a
  // md5 hash
  hash: null,

  // A string denoting the build to apply to the config file
  build: null,

  // If true, applies the `hmr` build to the config file. The build injects code to
  // connect to `opts.hmrRoot` and handle hot module replacement
  hmr: false

  // The base address that hot module replacement requests should be sent
  // to. Example: 'http://127.0.0.1:8000'
  hmrRoot: null,

  // An override for the config's `output.path` property
  outputPath: null,
  
  // An absolute path to the root directory of your static assets,
  // used to calculate `stats.urlsToAssets`
  staticRoot: null,
  
  // The url that your static assets are served from, used to calculate 
  // `stats.urlsToAssets` and configure HMR support
  staticUrl: null,

  // The delay between the detection of a change in your source files and
  // the start of a watcher's rebuild process
  aggregateTimeout: 200,
  
  // Indicates if the watcher should poll for changes, rather than 
  // relying on the OS for notifications
  poll: undefined,

  // An override for the config's output.publicPath setting
  publicPath: '...'

  // The path on `opts.hmrRoot` that socket connections are made to
  hmrPath: '/__webpack_hmr__',

  // The socket.io namespace that is used by the generated assets. If not
  // defined, it is set to `'/' + opts.hash`
  hmrNamespace: null,
  
  // A console-like object which is written to when the wrapper's state
  // changes, mostly of use for debugging. To suppress all output, set 
  // it to `null`
  logger: console
  
}
```


Caching
-------

The wrapper uses a mixture of file and memory caches to improve build times. Specifying the `cacheFile`
option will allow the wrapper to persist the cache to disk, which can boost build times.

When a request comes in and the cache has a record matching the `cacheKey` option, the cached data is
compared against the current timestamps on both the config file and the source files. If the file system
indicates that the cached data may be out of date, the wrapper will ignore the cached data and then 
wait for webpack to complete a fresh build.

If the `watch` option is set to true, as soon as the cached data is served, the watcher is started in
the background.

Whenever a compiler successfully builds, the cache is immediately updated with the output from the 
build process.

If you want to read cache files from another process, you should probably define the `cacheKey` or `hash` 
options to ensure that the cache entries are easily accessible.


Environment configuration
-------------------------

You can specify functions in your config file which can be run to generate env-specific configuration.

```javascript
module.exports = {
  // ...
  env: {
    dev: function(config, opts) {
      config.devtool = 'eval';

      config.loaders.push({
        // ...
      });
    },
    prod: function(config, opts) {
      config.devtool = 'source-map';
    }
  }
};
```

To apply any environment configuration, pass in the `env` option to the wrapper

```javascript
var build = require('webpack-build');

build({
  // ...
  env: 'dev'
}, function(err, stats) {
  // ...
});
```

The wrapper also comes with some convenience functions that apply changes to handle common
situations and help you avoid boilerplate.

```javascript
var build = require('webpack-build');

module.exports = {
  // ...
  env: {
    dev: function(config, opts) {
      build.env.dev(config, opts);

      // ...
    }
  }
};
```

The available env functions are:

**improve**

```javascript
require('webpack-build').env.improve;
```

Adds `new webpack.optimize.OccurrenceOrderPlugin()`

Adds `new webpack.NoErrorsPlugin()`


**dev**

```javascript
require('webpack-build').env.dev;
```

Applies the `improve` env

Sets `devtool` to `eval-source-maps`

Sets `output.pathinfo` to `true`

Adds

```
new webpack.DefinePlugin({
  'process.env': {
    NODE_ENV: JSON.stringify('development')
  }
})
```


**hmr**

```javascript
require('webpack-build').env.hmr;
```

Applies the `improve` env

Adds `webpack-wrapper/lib/hmr/client?...` and `webpack/hot/only-dev-server` to the config's entries.
These enable the client-side to talk to the HMR endpoint.

Adds `new webpack.HotModuleReplacementPlugin()`

Sets `output.publicPath` to the value of the `staticUrl` option

Sets `recordsPath` to `path.join(opts.outputPath, 'webpack.records-' + opts.hash + '.json');`


### prod

```javascript
require('webpack-build').env.prod;
```

Applies the `improve` env

Sets `devtool` to `source-map`

Adds `new webpack.optimize.DedupePlugin()`

Adds `new webpack.optimize.UglifyJsPlugin()`

Adds
```
new webpack.DefinePlugin({
  'process.env': {
    NODE_ENV: JSON.stringify('production')
  }
})
```


HMR
---

The wrapper includes hooks to add HMR functionality to both your front-end and back-end.

```javascript
// To use it with express

var http = require('http');
var express = require('express');
var build = require('webpack-build');

var app = express();
var server = http.Server(app);

build.hmr.addTo(server);

server.listen(8000);
```

The `addTo` method adds a socket.io handler to the endpoint defined by the `hmrPath` option,
which defaults to `/__webpack_hmr__`. You can provide a second argument to `addTo` to
change the path, but you'll need to provide that same value as the `hmrPath` option whenever
you call the wrapper.

And ensure that you inform the wrapper to apply the hmr build with respect to your server setup

```javascript
var build = require('webpack-build');

build({
  // ...
  outputPath: '/path/to/dir',
  hmr: true,
  hmrRoot: 'http://127.0.0.1:8000',
  publicPath: '/static',
}, function(err, stats) {
  // ...
});
```

Colophon
--------

Large portions of this codebase are heavily indebted to
[webpack-dev-middleware](https://github.com/webpack/webpack-dev-middleware) and
[webpack-dev-server](https://github.com/webpack/webpack-dev-server).

This project stands on the shoulders of giants - specifically, Tobias Koppers and the webpack 
ecosystem's vast number of contributors.
