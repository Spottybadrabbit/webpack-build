{"version":3,"sources":["../src/Wrapper.js"],"names":[],"mappings":"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","file":"Wrapper.js","sourcesContent":["import path from 'path';\nimport _ from 'lodash';\nimport webpack from 'webpack';\nimport Watcher from './Watcher';\nimport options from './options';\nimport hmr from './hmr';\nimport hmrConfig from './hmr/config';\nimport log from './log';\nimport packageJson from '../package';\n\nclass Wrapper {\n  constructor(opts, config, cache) {\n    this.opts = options(opts);\n\n    this.logger = log('wrapper', this.opts);\n\n    // TODO: remove this, it's mostly legacy in the test suite. Should simply pass the config obj as `opts.config`\n    // Convenience hook to pass an object in. You can also define\n    // `opts.config` as a path to a file\n    this.config = config;\n\n    this.cache = cache;\n\n    // State\n    this.watcher = null;\n\n    // Callbacks\n    this._onceDone = [];\n  }\n  getConfig(cb) {\n    if (this.config) {\n      return cb(null, this.config);\n    }\n\n    if (!this.opts.config) {\n      return cb(new Error('Wrapper options missing `config` value'));\n    }\n\n    this.config = this.opts.config;\n\n    if (_.isString(this.config)) {\n      this.logger(`loading config file ${this.opts.config}`);\n      try {\n        this.config = require(this.config);\n      } catch(err) {\n        this.config = null;\n        return cb(err);\n      }\n    }\n\n    if (this.config && this.opts.hmr) {\n      try {\n        hmrConfig(this.config, this.opts);\n      } catch(err) {\n        return cb(err);\n      }\n    }\n\n    if (this.opts.outputPath && this.config.output) {\n      this.config.output.path = this.opts.outputPath;\n    }\n\n    if (this.config && this.config.env && this.opts.env in this.config.env) {\n      this.logger(`applying env \"${this.opts.env}\"`);\n      let env = this.config.env[this.opts.env];\n      try {\n        env(this.config, this.opts);\n      } catch(err) {\n        return cb(err);\n      }\n    }\n\n    cb(null, this.config)\n  }\n  getCompiler(cb) {\n    this.getConfig((err, config) => {\n      if (err) return cb(err);\n\n      let compiler = webpack(config);\n\n      compiler.plugin('done', (stats) => {\n        if (stats.hasErrors()) {\n          this.logger('build error(s)', _.pluck(stats.compilation.errors, 'stack'));\n        }\n      });\n\n      if (this.opts.config && this.cache) {\n        compiler.plugin('done', (stats) => {\n          // TODO: get startTime/endTime from the stats\n          if (stats.hasErrors()) {\n            this.cache.set(null);\n          } else {\n            this.cache.set(\n              this.generateOutput(stats),\n              this.opts.watch\n            );\n          }\n        });\n      }\n\n      if (this.opts.watch && this.opts.hmr && this.opts.hmrRoot) {\n        hmr.bindCompiler(compiler, this.opts);\n      }\n\n      cb(null, compiler);\n    });\n  }\n  compile(cb) {\n    this.getCompiler((err, compiler) => {\n      if (err) return cb(err);\n\n      compiler.run((err, stats) => {\n        if (!err && stats.hasErrors()) {\n          err = _.first(stats.compilation.errors);\n        }\n\n        this.logger('compiler completed');\n        this.handleErrAndStats(err, stats, cb);\n      });\n    });\n  }\n  generateOutput(stats) {\n    if (!stats) return null;\n\n    let data = {\n      startTime: stats.startTime,\n      endTime: stats.endTime,\n      stats: stats.toJson({\n        modules: false,\n        source: false\n      }),\n      fileDependencies: stats.compilation.fileDependencies,\n      dependencies: {\n        webpack: require('webpack/package').version,\n        'webpack-build': packageJson.version\n      },\n      config: this.opts.config,\n      hash: this.opts.hash,\n      pathsToAssets: _.transform(\n        stats.compilation.assets,\n        (result, obj, asset) => result[asset] = obj.existsAt,\n        {}\n      ),\n      urlsToAssets: {},\n      rendered: {\n        script: [],\n        link: []\n      }\n    };\n\n    if (this.opts.staticRoot && this.opts.staticUrl) {\n      _.forEach(data.pathsToAssets, (absPath, asset) => {\n        let relPath = absPath.replace(this.opts.staticRoot, '');\n\n        let relUrl = relPath.split(path.sep).join('/');\n        if (_.startsWith(relUrl, '/')) {\n          relUrl = relUrl.slice(1);\n        }\n\n        let url = this.opts.staticUrl + relUrl;\n        data.urlsToAssets[asset] = url;\n\n        if (path.extname(relPath) === '.css') {\n          data.rendered.link.push(`<link rel=\"stylesheet\" href=\"${url}\">`);\n        } else if (path.extname(relPath) === '.js') {\n          data.rendered.script.push(`<script src=\"${url}\"></script>`);\n        }\n      });\n    }\n\n    if (this.config) {\n      data.webpackConfig = this.config;\n    } else if (this.opts.config) {\n      try {\n        data.webpackConfig = require(this.opts.config);\n      } catch(err) {}\n    }\n\n    return data;\n  }\n  handleErrAndStats(err, stats, cb) {\n    if (err) {\n      return cb(err);\n    }\n\n    if (stats.hasErrors()) {\n      err = _.first(stats.compilation.errors);\n    }\n\n    cb(err, this.generateOutput(stats));\n  }\n  getWatcher(cb) {\n    if (this.watcher) {\n      return cb(null, this.watcher);\n    }\n\n    this.getCompiler((err, compiler) => {\n      if (err) return cb(err);\n\n      try {\n        this.watcher = new Watcher(compiler, this.opts);\n      } catch(err) {\n        return cb(err);\n      }\n\n      if (this.opts.config) {\n        this.watcher.onInvalid(() => {\n          this.logger('watcher detected a change');\n        });\n      }\n\n      this.watcher.onFailure((err) => {\n        this.logger('watcher failed', err.stack);\n      });\n\n      cb(null, this.watcher);\n    });\n  }\n  onceWatcherDone(cb) {\n    this.getWatcher((err, watcher) => {\n      if (err) return cb(err);\n\n      watcher.onceDone((err, stats) => {\n        if (err) return cb(err, stats);\n\n        this.logger('watcher provided current build output');\n\n        this.handleErrAndStats(err, stats, cb);\n      });\n    });\n  }\n  onceDone(cb) {\n    this._onceDone.push(cb);\n\n    this.logger('build requested');\n\n    if (this.opts.watch) {\n      if (this._onceDone.length === 1) {\n        this.onceWatcherDone(this.callDone.bind(this));\n      }\n    } else {\n      this.compile(this.callDone.bind(this));\n    }\n  }\n  callDone(err, stats) {\n    let _onceDone = this._onceDone;\n    this._onceDone = [];\n\n    _onceDone.forEach(\n      (cb) => cb(err, stats)\n    );\n  }\n}\n\nexport default Wrapper;"]}