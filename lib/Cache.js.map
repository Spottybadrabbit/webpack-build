{"version":3,"sources":["../src/Cache.js"],"names":[],"mappings":"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","file":"Cache.js","sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport async from 'async';\nimport mkdirp from 'mkdirp';\nimport logger from './logger';\nimport packageJson from '../package';\n\nclass Cache {\n  constructor(opts) {\n    this.filename = opts.cacheFile;\n    this.logger = logger('cache', opts);\n\n    // A flag denoting that another part of the system will serve\n    // the data, rather than this cache\n    this.delegate = false;\n\n    try {\n      let data = fs.readFileSync(this.filename);\n      this.data = JSON.parse(data.toString());\n      this.logger('loaded cache file');\n    } catch(err) {\n      this.logger('cache load error', err.message);\n    }\n\n    if (!this.data) {\n      this.data = {};\n    }\n\n    // Update the file with the current state\n    this.write();\n  }\n  get(cb) {\n    let data = this.data;\n\n    if (!data || !Object.keys(data).length) {\n      this.logger('no data available');\n\n      return cb(null, null);\n    }\n\n    let requiredProps = ['startTime', 'fileDependencies', 'stats', 'config', 'hash', 'dependencies'];\n\n    for (let i=0; i<requiredProps.length; i++) {\n      if (!data[requiredProps[i]]) {\n        this.logger('cached data is missing the ' + requiredProps[i] + ' prop');\n\n        return cb(null, null);\n      }\n    }\n\n    // Check dependency versions\n    const depNames = Object.keys(data.dependencies);\n    for (let i=0; i<depNames.length; i++) {\n      let depName = depNames[i];\n      let requiredDepVersion = data.dependencies[depName];\n\n      let depVersion;\n      if (depName === packageJson.name) {\n        depVersion = packageJson.version\n      } else {\n        try {\n          depVersion = require(depName + '/package').version;\n        } catch(err) {\n          this.logger('cached data references a dependency ' + depName + ' which produced an error during version checks');\n          return cb(err, null);\n        }\n      }\n\n      if (depVersion !== requiredDepVersion) {\n        this.logger(\n          'cached data references a dependency ' + depName + '@' + requiredDepVersion + ' but the ' +\n          'installed version is ' + depName + '@' + requiredDepVersion\n        );\n\n        return cb(null, null);\n      }\n    }\n\n    // Check the modified times on the config file\n    let configFile = data.config;\n    fs.stat(configFile, function(err, stats) {\n      if (err) return cb(err);\n\n      if (+stats.mtime > data.startTime) {\n        return cb(new Error(\n          'Stale config file: ' + configFile + '. ' +\n          'Compile start time: ' + data.startTime + '. ' +\n          'File mtime: ' + (+stats.mtime)\n        ));\n      }\n\n      // Check the modified times on the file dependencies\n      async.each(\n        data.fileDependencies,\n        function(filename, cb) {\n          fs.stat(filename, function(err, stats) {\n            if (err) return cb(err);\n\n            if (+stats.mtime > data.startTime) {\n              return cb(new Error(\n                'Stale file dependency: ' + filename + '. ' +\n                'Compile start time: ' + data.startTime + '. ' +\n                'File mtime: ' + (+stats.mtime)\n              ));\n            }\n\n            cb(null, true);\n          });\n        },\n        function(err) {\n          if (err) {\n            this.logger('cache retrieval error', err.message);\n            return cb(err);\n          }\n\n          this.logger('serving cached data');\n          cb(null, data);\n        }.bind(this)\n      );\n    }.bind(this));\n  }\n  set(data, delegate) {\n    this.data = data;\n\n    if (delegate) {\n      // Indicate that the we should no longer rely on the cache's store.\n      // This enables the watcher's internal cache to take over the service\n      // of cached output\n      this.delegate = true;\n    }\n\n    if (data) {\n      this.logger('updated cache file');\n    } else {\n      this.logger('cleared cache file');\n    }\n\n    this.write();\n  }\n  write() {\n    let json = JSON.stringify(this.data, null, 2);\n\n    try {\n      mkdirp.sync(path.dirname(this.filename));\n    } catch(err) {\n      throw new Error('Failed to create path to webpack cache file: ' + this.filename);\n    }\n\n    try {\n      fs.writeFileSync(this.filename, json);\n    } catch(err) {\n      throw new Error('Failed to write webpack cache file: ' + this.filename);\n    }\n\n    this.logger('updated cache file');\n  }\n}\n\n\nexport default Cache;"]}