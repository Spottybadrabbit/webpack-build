{"version":3,"sources":["../../src/workers/index.js"],"names":[],"mappings":";;;;;;;;;;;;kBAAe,IAAI;;;;sBACL,QAAQ;;;;uBACF,YAAY;;;;sBACb,UAAU;;;;IAEvB,OAAO;AACA,WADP,OAAO,GACG;0BADV,OAAO;;AAET,QAAI,CAAC,OAAO,GAAG,EAAE,CAAC;AAClB,QAAI,CAAC,IAAI,GAAG,CAAC,CAAC;AACd,QAAI,CAAC,OAAO,GAAG,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;GACpC;;eALG,OAAO;;WAMD,sBAAG;AACX,aAAO,IAAI,CAAC,OAAO,CAAC,MAAM,GAAG,CAAC,CAAC;KAChC;;;WACI,eAAC,MAAM,EAAE;;;;;AAGZ,YAAM,GAAG,MAAM,IAAI,gBAAG,IAAI,EAAE,CAAC,MAAM,CAAC;;AAEpC,0BAAE,KAAK,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,YAAM;AAC5B,cAAK,OAAO,CAAC,IAAI,CAAC,yBAAY,CAAC,CAAC;OACjC,CAAC,CAAC;KACJ;;;WACI,eAAC,IAAI,EAAE,EAAE,EAAE;;;AAGd,UAAI,GAAG,0BAAQ,IAAI,CAAC,CAAC;;AAErB,UAAI,CAAC,IAAI,CAAC,UAAU,EAAE,EAAE;AACtB,eAAO,EAAE,CAAC,IAAI,KAAK,CAAC,sBAAsB,CAAC,CAAC,CAAC;OAC9C;;AAED,UAAI,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;;AAE9B,UAAI,CAAC,MAAM,EAAE;AACX,cAAM,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;AAC1B,YAAI,CAAC,OAAO,CAAC,IAAI,CAAC,SAAS,CAAC,GAAG,MAAM,CAAC,GAAG,CAAC;OAC3C;;AAED,YAAM,CAAC,KAAK,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC;KACxB;;;WACI,eAAC,IAAI,EAAE;;;;AAIV,UAAI,GAAG,GAAG,IAAI,CAAC,SAAS,CAAC;AACzB,UAAI,GAAG,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;AAC5B,UAAI,GAAG,EAAE;AACP,eAAO,oBAAE,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,EAAE,GAAG,EAAH,GAAG,EAAE,CAAC,CAAC;OACtC;KACF;;;WACE,eAAG;;;AAGJ,UAAI,MAAM,GAAG,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;;AAErC,UAAI,CAAC,IAAI,EAAE,CAAC;AACZ,UAAI,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE;AACpC,YAAI,CAAC,IAAI,GAAG,CAAC,CAAC;OACf;;AAED,aAAO,MAAM,CAAC;KACf;;;WACI,iBAAG;;;;;;AACN,6BAAmB,IAAI,CAAC,OAAO,8HAAE;cAAxB,MAAM;;AACb,gBAAM,CAAC,IAAI,EAAE,CAAC;SACf;;;;;;;;;;;;;;;;AACD,UAAI,CAAC,OAAO,GAAG,EAAE,CAAC;AAClB,UAAI,CAAC,OAAO,GAAG,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;AACnC,UAAI,CAAC,IAAI,GAAG,CAAC,CAAC;KACf;;;SAjEG,OAAO;;;qBAoEE,IAAI,OAAO,EAAE","file":"index.js","sourcesContent":["import os from 'os';\nimport _ from 'lodash';\nimport options from '../options';\nimport Worker from './Worker';\n\nclass Workers {\n  constructor() {\n    this.workers = [];\n    this.next = 0;\n    this.matches = Object.create(null);\n  }\n  hasWorkers() {\n    return this.workers.length > 0;\n  }\n  spawn(number) {\n    // Spawns the number of workers specified\n\n    number = number || os.cpus().length;\n\n    _.range(number).forEach(() => {\n      this.workers.push(new Worker());\n    });\n  }\n  build(opts, cb) {\n    // Passes `opts` to an available worker\n\n    opts = options(opts);\n\n    if (!this.hasWorkers()) {\n      return cb(new Error('No workers available'));\n    }\n\n    let worker = this.match(opts);\n\n    if (!worker) {\n      worker = this.get(worker);\n      this.matches[opts.buildHash] = worker.pid;\n    }\n\n    worker.build(opts, cb);\n  }\n  match(opts) {\n    // Returns a worker, if any, which has previously build `opts` and is likely\n    // to have a warm compiler\n\n    let key = opts.buildHash;\n    let pid = this.matches[key];\n    if (pid) {\n      return _.find(this.workers, { pid });\n    }\n  }\n  get() {\n    // Returns the next available worker\n\n    let worker = this.workers[this.next];\n\n    this.next++;\n    if (this.next >= this.workers.length) {\n      this.next = 0;\n    }\n\n    return worker;\n  }\n  clear() {\n    for (let worker of this.workers) {\n      worker.kill();\n    }\n    this.workers = [];\n    this.matches = Object.create(null);\n    this.next = 0;\n  }\n}\n\nexport default new Workers();"]}